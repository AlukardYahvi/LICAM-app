<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Riesgo Cardiometab√≥lico Integral (v2.0 - Impresi√≥n)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluimos Quicksand para una tipograf√≠a m√°s moderna y amigable -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados para la tesis */
        body {
            font-family: 'Quicksand', sans-serif; /* Usamos la fuente m√°s amigable */
            background-color: #e6e9f0; /* Fondo m√°s suave */
            /* NUEVO: Fondo con gradiente sutil y patr√≥n geom√©trico que evoca lo m√©dico/cient√≠fico */
            background-image: radial-gradient(#ffffff 1px, transparent 0), radial-gradient(#ffffff 1px, #f5f6f8 0);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        /* Paleta de riesgo */
        .risk-low { background-color: #d1fae5; color: #065f46; border-color: #34d399; }
        .risk-moderate { background-color: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .risk-high { background-color: #fee2e2; color: #991b1b; border-color: #f87171; }
        .risk-very-high { background-color: #eeb8b8; color: #570a0a; border-color: #c95d5d; } /* Color para Muy Alto Riesgo */

        /* IPN/ESM Accent - Color Ligeramente m√°s vivo y elegante */
        .ipn-accent { color: #8e1c1c; } /* Guinda m√°s profundo */
        .ipn-border { border-color: #8e1c1c; }
        .ipn-bg { background-color: #8e1c1c; }
        .shadow-glow {
            /* Sombra m√°s profunda y enfocada en el color IPN */
            box-shadow: 0 5px 20px rgba(142, 28, 28, 0.4);
        }
        
        /* Estilo para el contenedor principal de la p√°gina: m√°s redondeado y con mejor sombra */
        .main-container {
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            background-color: #ffffff; /* Asegura el blanco para el contenido del formulario */
            padding: 2.5rem; 
            border-radius: 1.5rem; /* Bordes m√°s redondeados */
            box-shadow: 0 30px 40px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08);
            border-top: 10px solid #8e1c1c; /* Borde superior m√°s grueso */
        }

        /* MEJORA DE INPUTS: A√±ade un estilo de focus m√°s claro y con el color IPN */
        .input-stylish {
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .input-stylish:focus {
            border-color: #8e1c1c !important; /* Rojo IPN en focus */
            box-shadow: 0 0 0 3px rgba(142, 28, 28, 0.25) !important;
            outline: none;
        }

        /* AJUSTES PARA IMPRESI√ìN */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                padding: 0;
                margin: 0;
                background-color: #ffffff;
                background-image: none; /* Elimina el fondo est√©tico al imprimir */
            }
            .main-container {
                max-width: 100% !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            header, #results-section {
                display: block !important;
            }
            .risk-low, .risk-moderate, .risk-high, .risk-very-high {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background-color: inherit;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- === AVISO DE PRIVACIDAD (OBLIGATORIO ANTES DE FORMULARIO) === -->
    <div id="privacy-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl p-8 mx-4 border-t-8 ipn-border overflow-y-auto max-h-[90vh]">
            <!-- T√çTULO MEJORADO CON ICONO -->
            <h2 class="text-2xl md:text-3xl font-extrabold ipn-accent mb-4 text-center">üõ°Ô∏è Aviso de Privacidad y Uso de Datos Personales</h2>
            <p class="text-gray-700 text-sm leading-relaxed mb-3">
                El <strong>Laboratorio de Investigaci√≥n Cardiometab√≥lica (LICAM)</strong> del <strong>Instituto Polit√©cnico Nacional (IPN)</strong>, es responsable del tratamiento de los datos personales que usted proporcione en esta <strong>Calculadora de Riesgo Cardiometab√≥lico</strong>.
            </p>
            <p class="text-gray-700 text-sm leading-relaxed mb-3">
                Sus datos ser√°n utilizados <strong>√∫nicamente con fines estad√≠sticos, acad√©micos y de investigaci√≥n cient√≠fica</strong> para el an√°lisis de riesgo cardiometab√≥lico en la poblaci√≥n participante del Segundo Simposio de Medicina. 
                La informaci√≥n ser√° manejada de forma <strong>an√≥nima y confidencial</strong>, conforme a la <em>Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares (LFPDPPP)</em>.
            </p>
            <ul class="text-gray-700 text-sm list-disc ml-5 mb-3">
                <li>No se compartir√° su informaci√≥n con terceros ajenos al IPN.</li>
                <li>Los resultados ser√°n presentados de manera agrupada y sin identificar individualmente a los participantes.</li>
                <li>Usted puede ejercer sus derechos ARCO (Acceso, Rectificaci√≥n, Cancelaci√≥n y Oposici√≥n) contactando a: <strong>nnajerag@ipn.mx</strong>.</li>
            </ul>
            <p class="text-gray-700 text-sm leading-relaxed mb-3">
                Al continuar, usted declara haber le√≠do y comprendido este aviso, otorgando su consentimiento para el uso descrito de sus datos con fines de investigaci√≥n y an√°lisis cient√≠fico.
            </p>

            <div class="flex items-center justify-center space-x-2 mt-6">
                <input type="checkbox" id="acceptPrivacy" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                <label for="acceptPrivacy" class="text-base text-gray-800 font-semibold select-none">He le√≠do y acepto el Aviso de Privacidad.</label>
            </div>
            <!-- BOT√ìN MEJORADO EST√âTICAMENTE -->
            <div class="mt-8 flex justify-center">
                <button id="continueBtn" disabled class="bg-gray-400 cursor-not-allowed text-white font-extrabold py-3 px-8 rounded-xl shadow-lg transition-all duration-300 transform hover:scale-105">
                    Continuar al Formulario üöÄ
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-center italic">√öltima actualizaci√≥n: noviembre 2025 ¬∑ ¬© LICAM-IPN</p>
        </div>
    </div>

    <script>
        // === L√≥gica del Aviso de Privacidad (SIN MODIFICACIONES) ===
        const checkbox = document.getElementById("acceptPrivacy");
        const continueBtn = document.getElementById("continueBtn");
        const overlay = document.getElementById("privacy-overlay");

        checkbox.addEventListener("change", () => {
            continueBtn.disabled = !checkbox.checked;
            continueBtn.classList.toggle("bg-gray-400", !checkbox.checked);
            continueBtn.classList.toggle("cursor-not-allowed", !checkbox.checked);
            /* Uso de la clase IPN mejorada */
            continueBtn.classList.toggle("ipn-bg", checkbox.checked);
            continueBtn.classList.toggle("hover:bg-red-800", checkbox.checked);
        });

        continueBtn.addEventListener("click", () => {
            overlay.classList.add("hidden");
        });
    </script>

    <div class="main-container">
        <header class="mb-10 border-b pb-4">
            <div class="grid grid-cols-3 items-center justify-between">
                <!-- LOGO IZQUIERDO RESTAURADO -->
                <div class="flex justify-start">
                    <a href="https://www.esm.ipn.mx/" target="_blank" title="Escuela Superior de Medicina - IPN">
                        <img src="logo_esm.png" alt="Logo ESM" class="h-16 w-16 md:h-20 md:w-20 object-contain shadow-md">
                    </a>
                </div>

                <div class="text-center col-span-1">
                    <!-- T√çTULO M√ÅS GRANDE Y AMIGABLE (Aesthetic change kept) -->
                    <h1 class="text-3xl md:text-4xl font-extrabold ipn-accent leading-tight">
                        Calculadora de Riesgo Cardiometab√≥lico
                    </h1>
                    <p class="text-sm md:text-md text-gray-600 mt-2 no-print font-semibold">
                        Proyecto de Tesis - <span class="ipn-accent">Ingenier√≠a en Biotecnolog√≠a</span>
                    </p>
                </div>

                <!-- LOGOS DERECHOS RESTAURADOS -->
                <div class="flex justify-end items-center space-x-4">
                    <a href="https://www.ipn.mx/" target="_blank" title="Instituto Polit√©cnico Nacional">
                        <img src="logo_ipn.png" alt="Logo IPN" class="h-16 w-16 md:h-20 md:w-20 object-contain shadow-lg">
                    </a>
                    <a href="cemiztli.wixsite.com/cardiometabolismo" target="_blank" title="Laboratorio LICAM" class="hidden sm:block">
                        <img src="logo_licam.png" alt="Logo LICAM" class="h-12 w-12 md:h-16 md:w-16 object-contain rounded-full shadow-md">
                    </a>
                </div>
            </div>
        </header>

        <form id="calc-form" class="no-print">
            <div id="validation-message" class="hidden p-3 mb-4 rounded-lg bg-red-100 text-red-700 font-semibold border-l-4 border-red-500 shadow-md"></div>
            <div id="input-form">
                
                <!-- SECCI√ìN 1: Datos Personales con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üë§ 1. Datos Personales</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="full_name" class="block text-sm font-bold text-gray-700">Nombre Completo</label>
                        <input type="text" id="full_name" placeholder="Nombre(s) Apellido(s)" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="birth_date" class="block text-sm font-bold text-gray-700">üìÖ Fecha de Nacimiento</label>
                        <input type="date" id="birth_date" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-bold text-gray-700">üöª Sexo Biol√≥gico</label>
                        <select id="gender" class="mt-1 block w-full pl-3 pr-10 py-2 text-base input-stylish focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
                            <option value="male">Masculino</option>
                            <option value="female">Femenino</option>
                        </select>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-bold text-gray-700">üìß Correo Electr√≥nico (Opcional)</label>
                        <input type="email" id="email" placeholder="ejemplo@correo.com" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                </div>

                <!-- SECCI√ìN 2: Signos Vitales con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üíñ 2. Signos Vitales y Dinamometr√≠a</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="hr" class="block text-sm font-medium text-gray-700">Frec. Card√≠aca (lpm) ‚ù§Ô∏è</label>
                        <input type="number" id="hr" placeholder="60-100" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="rr" class="block text-sm font-medium text-gray-700">Frec. Respiratoria (rpm) üå¨Ô∏è</label>
                        <input type="number" id="rr" placeholder="12-20" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="grip_right" class="block text-sm font-medium text-gray-700">Fuerza Agarre Der. (Kg) üí™</label>
                        <input type="number" step="0.1" id="grip_right" placeholder="30.5" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="grip_left" class="block text-sm font-medium text-gray-700">Fuerza Agarre Izq. (Kg) üí™</label>
                        <input type="number" step="0.1" id="grip_left" placeholder="29.8" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                </div>

                <h3 class="text-xl font-bold text-gray-700 mb-3 border-b pb-1">2.1. Presi√≥n Arterial (Medici√≥n Principal) ü©∏</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="pas" class="block text-sm font-medium text-gray-700">Presi√≥n Sist√≥lica (mmHg)</label>
                        <input type="number" id="pas" value="120" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="pad" class="block text-sm font-medium text-gray-700">Presi√≥n Diast√≥lica (mmHg)</label>
                        <input type="number" id="pad" value="80" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="pa_d2_s" class="block text-sm font-medium text-gray-700">PA D√≠a 2 S/D (Opcional)</label>
                        <div class="flex space-x-2">
                            <input type="number" id="pa_d2_s" placeholder="Sist√≥lica" class="mt-1 block w-1/2 rounded-md input-stylish p-2 border">
                            <input type="number" id="pa_d2_d" placeholder="Diast√≥lica" class="mt-1 block w-1/2 rounded-md input-stylish p-2 border">
                        </div>
                    </div>
                    <div>
                        <label for="pa_d3_s" class="block text-sm font-medium text-gray-700">PA D√≠a 3 S/D (Opcional)</label>
                        <div class="flex space-x-2">
                            <input type="number" id="pa_d3_s" placeholder="Sist√≥lica" class="mt-1 block w-1/2 rounded-md input-stylish p-2 border">
                            <input type="number" id="pa_d3_d" placeholder="Diast√≥lica" class="mt-1 block w-1/2 rounded-md input-stylish p-2 border">
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 3: Antropometr√≠a con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üìè 3. Antropometr√≠a</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="height" class="block text-sm font-medium text-gray-700">Estatura (cm) ‚¨ÜÔ∏è</label>
                        <input type="number" id="height" value="170" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-700">Peso (kg) ‚öñÔ∏è</label>
                        <input type="number" id="weight" value="75" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="waist" class="block text-sm font-medium text-gray-700">Per√≠metro Cintura (cm) ‚≠ï</label>
                        <input type="number" id="waist" value="90" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="hip" class="block text-sm font-medium text-gray-700">Per√≠metro Cadera (cm) üçë</label>
                        <input type="number" id="hip" value="100" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                </div>

                <!-- SECCI√ìN 4: Bioqu√≠micos con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üß™ 4. Par√°metros Bioqu√≠micos</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="glucose" class="block text-sm font-medium text-gray-700">Glucosa Ayunas (mg/dL) üç¨</label>
                        <input type="number" id="glucose" value="90" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="hba1c" class="block text-sm font-medium text-gray-700">HbA1c (%) (Opcional) üìä</label>
                        <input type="number" step="0.1" id="hba1c" placeholder="5.7" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="total_chol" class="block text-sm font-medium text-gray-700">Colesterol Total (mg/dL) ü•ì</label>
                        <input type="number" id="total_chol" placeholder="180" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="hdl" class="block text-sm font-medium text-gray-700">Colesterol HDL (mg/dL) ‚ú®</label>
                        <input type="number" id="hdl" value="45" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="ldl" class="block text-sm font-medium text-gray-700">Colesterol LDL (mg/dL) üíî</label>
                        <input type="number" id="ldl" placeholder="110" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="triglycerides" class="block text-sm font-medium text-gray-700">Triglic√©ridos (mg/dL) üçü</label>
                        <input type="number" id="triglycerides" value="140" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                </div>

                <!-- SECCI√ìN 5: Composici√≥n Corporal con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üèãÔ∏è 5. Composici√≥n Corporal (Opcional, si usa BIA)</h2>
                <p class="text-sm text-gray-600 -mt-3 mb-4 italic p-2 bg-gray-100 rounded-md">Llenar solo si tiene datos de una b√°scula de Bioimpedancia (BIA). Estos campos no se calculan solos.</p>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
                    <div>
                        <label for="bia_fat_p" class="block text-sm font-medium text-gray-700">% Grasa Corporal üßç</label>
                        <input type="number" step="0.1" id="bia_fat_p" placeholder="25.5" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="bia_muscle_p" class="block text-sm font-medium text-gray-700">% M√∫sculo üí™</label>
                        <input type="number" step="0.1" id="bia_muscle_p" placeholder="34.0" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="bia_visceral_p" class="block text-sm font-medium text-gray-700">% Grasa Visceral üî•</label>
                        <input type="number" step="0.1" id="bia_visceral_p" placeholder="9" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="bia_water_p" class="block text-sm font-medium text-gray-700">% Agua üíß</label>
                        <input type="number" step="0.1" id="bia_water_p" placeholder="55.0" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="bia_metabolic_age" class="block text-sm font-medium text-gray-700">Edad Metab√≥lica ‚è≥</label>
                        <input type="number" id="bia_metabolic_age" placeholder="40" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                </div>

                <!-- SECCI√ìN 6: Estilo de Vida con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üçé 6. Estilo de Vida</h2>
                <h3 class="text-xl font-bold text-gray-700 mb-3 border-b pb-1">6.1. Actividad F√≠sica üèÉ</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="activity_days" class="block text-sm font-medium text-gray-700">D√≠as de ejercicio/semana</label>
                        <select id="activity_days" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="0">0 (Sedentario)</option>
                            <option value="2">1-2 d√≠as</option>
                            <option value="3.5">3-4 d√≠as</option>
                            <option value="5">5 o m√°s d√≠as</option>
                        </select>
                    </div>
                    <div>
                        <label for="activity_duration" class="block text-sm font-medium text-gray-700">Duraci√≥n promedio (min/d√≠a)</label>
                        <input type="number" id="activity_duration" placeholder="30" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="activity_intensity" class="block text-sm font-medium text-gray-700">Intensidad Principal</label>
                        <select id="activity_intensity" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="light">Ligera (Caminar) üö∂</option>
                            <option value="moderate">Moderada (Trotar, Bici) üö¥</option>
                            <option value="vigorous">Vigorosa (Correr, HIIT) üí•</option>
                        </select>
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-700 mb-3 border-b pb-1">6.2. Tabaquismo üö¨</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="smoker_status" class="block text-sm font-medium text-gray-700">Estado</label>
                        <select id="smoker_status" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="never">Nunca he fumado</option>
                            <option value="ex_smoker">Ex-fumador</option>
                            <option value="active">Fumador Actual</option>
                        </select>
                    </div>
                    <div>
                        <label for="smoker_passive" class="block text-sm font-medium text-gray-700">Fumador Pasivo</label>
                        <select id="smoker_passive" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="no">No</option>
                            <option value="yes">S√≠ (convive con fumadores)</option>
                        </select>
                    </div>
                    <div>
                        <label for="smoker_years" class="block text-sm font-medium text-gray-700">A√±os fumando (si aplica)</label>
                        <input type="number" id="smoker_years" placeholder="10" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="smoker_daily_avg" class="block text-sm font-medium text-gray-700">Cigarrillos/d√≠a (promedio)</label>
                        <input type="number" id="smoker_daily_avg" placeholder="5" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                </div>
                <h3 class="text-xl font-bold text-gray-700 mb-3 border-b pb-1">6.3. Consumo de Alcohol üçª</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label for="alcohol_freq" class="block text-sm font-medium text-gray-700">Frecuencia de consumo</label>
                        <select id="alcohol_freq" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="none">Nunca o casi nunca</option>
                            <option value="monthly">1-3 veces al mes</option>
                            <option value="weekly">1-2 veces por semana</option>
                            <option value="daily">Casi diario</option>
                        </select>
                    </div>
                    <div>
                        <label for="alcohol_dose" class="block text-sm font-medium text-gray-700">Dosis (Bebidas est√°ndar/d√≠a)</label>
                        <input type="number" id="alcohol_dose" placeholder="2" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                    </div>
                    <div>
                        <label for="alcohol_type" class="block text-sm font-medium text-gray-700">Tipo de alcohol principal</label>
                        <select id="alcohol_type" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="beer">Cerveza üç∫</option>
                            <option value="wine">Vino üç∑</option>
                            <option value="spirit">Destilados (Tequila, Ron, etc.) ü•É</option>
                            <option value="mixed">Combinado üçπ</option>
                        </select>
                    </div>
                </div>
                
                <!-- SECCI√ìN 7: Diagn√≥sticos con Icono y Contenedores resaltados -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üè• 7. Diagn√≥sticos y Tratamiento</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                    <div class="p-4 border-2 rounded-xl bg-red-50/70 border-red-300 shadow-md">
                        <label class="block text-base font-extrabold text-red-800">Diabetes Mellitus (DM) ü©∏</label>
                        <div class="mt-2 space-y-2 text-sm">
                            <div>
                                <input type="radio" id="dm_no" name="dm_status" value="no" checked> <label for="dm_no" class="font-medium">No diagnosticado</label>
                            </div>
                            <div>
                                <input type="radio" id="dm_yes" name="dm_status" value="yes"> <label for="dm_yes" class="font-medium">S√≠ diagnosticado</label>
                            </div>
                            <label for="med_dm" class="block text-sm font-semibold text-gray-700 mt-2">¬øToma Metformina, Glibenclamida, Insulina u otro?</label>
                            <select id="med_dm" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                                <option value="no">No</option>
                                <option value="yes_freq">S√≠, frecuentemente</option>
                                <option value="yes_rare">S√≠, ocasionalmente</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-4 border-2 rounded-xl bg-red-50/70 border-red-300 shadow-md">
                        <label class="block text-base font-extrabold text-red-800">Hipertensi√≥n (HTA) üå°Ô∏è</label>
                        <div class="mt-2 space-y-2 text-sm">
                            <div>
                                <input type="radio" id="hta_no" name="hta_status" value="no" checked> <label for="hta_no" class="font-medium">No diagnosticado</label>
                            </div>
                            <div>
                                <input type="radio" id="hta_yes" name="hta_status" value="yes"> <label for="hta_yes" class="font-medium">S√≠ diagnosticado</label>
                            </div>
                            <label for="med_hta" class="block text-sm font-semibold text-gray-700 mt-2">¬øToma Losart√°n, Captopril, Amlodipino u otro?</label>
                            <select id="med_hta" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                                <option value="no">No</option>
                                <option value="yes_freq">S√≠, frecuentemente</option>
                                <option value="yes_rare">S√≠, ocasionalmente</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-4 border-2 rounded-xl bg-red-50/70 border-red-300 shadow-md">
                        <label class="block text-base font-extrabold text-red-800">Dislipidemia (Colesterol/TG altos) üçî</label>
                        <div class="mt-2 space-y-2 text-sm">
                            <div>
                                <input type="radio" id="dlp_no" name="dlp_status" value="no" checked> <label for="dlp_no" class="font-medium">No diagnosticado</label>
                            </div>
                            <div>
                                <input type="radio" id="dlp_yes" name="dlp_status" value="yes"> <label for="dlp_yes" class="font-medium">S√≠ diagnosticado</label>
                            </div>
                            <label for="med_dlp" class="block text-sm font-semibold text-gray-700 mt-2">¬øToma Estatinas (Atorva, Rosuva) o Fibratos?</label>
                            <select id="med_dlp" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                                <option value="no">No</option>
                                <option value="yes_freq">S√≠, frecuentemente</option>
                                <option value="yes_rare">S√≠, ocasionalmente</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- SECCI√ìN 8: Historial con Icono -->
                <h2 class="text-2xl font-extrabold text-gray-800 mb-4 border-b-2 ipn-border pb-2">üìú 8. Historial Cardiovascular</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div>
                        <label for="history_mi" class="block text-sm font-medium text-gray-700">¬øHa sido diagnosticado con un Infarto? üíî</label>
                        <select id="history_mi" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="no">No</option>
                            <option value="yes">S√≠</option>
                        </select>
                    </div>
                    <div>
                        <label for="history_angina" class="block text-sm font-medium text-gray-700">¬øHa sentido dolor opresivo en el pecho al esforzarse (Angina)? ü©∫</label>
                        <select id="history_angina" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="no">No</option>
                            <option value="yes">S√≠</option>
                        </select>
                    </div>
                    <div>
                        <label for="family_history" class="block text-sm font-medium text-gray-700">Antecedentes Familiares (Padres/Hermanos con ECV o DM) üë®‚Äçüë©‚Äçüëß‚Äçüë¶</label>
                        <select id="family_history" class="mt-1 block w-full rounded-md input-stylish p-2 border">
                            <option value="no">No</option>
                            <option value="yes">S√≠</option>
                        </select>
                    </div>
                </div>

                <div id="sheet-status" class="text-center p-3 mt-4 rounded-lg text-sm hidden"></div>

                <!-- BOT√ìN DE C√ÅLCULO MEJORADO -->
                <button id="calculate-button" class="w-full mt-8 py-4 px-6 border border-transparent rounded-xl shadow-glow text-xl font-extrabold text-white ipn-bg hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    Calcular Riesgo Cardiovascular Integral üöÄ
                </button>
            </div>
        </form>

        <div id="results-section" class="hidden mt-10">
            <!-- T√çTULO DE RESULTADOS M√ÅS VIBRANTE -->
            <h2 class="text-3xl font-extrabold ipn-accent mb-8 border-b-4 ipn-border pb-3">‚úÖ 4. Resultados y Plan de Acci√≥n Personalizado</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <div class="p-8 rounded-3xl border-4 border-gray-100 shadow-xl space-y-6 bg-white">
                    <h3 class="text-2xl font-extrabold mb-4 ipn-accent border-b pb-2">Perfil de Riesgo üìä</h3>
                    <!-- Resultado Global con Sombra de Resplandor y tipograf√≠a grande -->
                    <div id="global-risk-result" class="text-center p-6 rounded-xl font-extrabold text-3xl mb-4 transition duration-300 shadow-glow"></div>
                    
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-bold text-gray-800 text-lg mb-2">M√©tricas Antropom√©tricas üßç:</h4>
                        <ul class="list-disc list-inside text-base text-gray-700 space-y-1">
                            <li><span class="font-extrabold">Edad:</span> <span id="res-age"></span> a√±os</li>
                            <li><span class="font-extrabold">IMC:</span> <span id="res-bmi-val"></span> <span id="res-bmi-class" class="font-extrabold"></span></li>
                            <li><span class="font-extrabold">√çndice Cintura-Cadera (ICC):</span> <span id="res-icc-val"></span> <span id="res-icc-class" class="font-extrabold"></span></li>
                        </ul>
                    </div>

                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-bold text-gray-800 text-lg mb-2">M√©tricas Bioqu√≠micas (√çndices) üß™:</h4>
                        <ul class="list-disc list-inside text-base text-gray-700 space-y-1">
                            <li><span class="font-extrabold">√çndice TG/HDL (Resistencia a Insulina):</span> <span id="res-tg-hdl-val"></span> <span id="res-tg-hdl-class" class="font-extrabold"></span></li>
                            <li><span class="font-extrabold">√çndice Col Total/HDL:</span> <span id="res-chol-hdl-val"></span> <span id="res-chol-hdl-class" class="font-extrabold"></span></li>
                            <li><span class="font-extrabold">MASLD (Riesgo H√≠gado Graso):</span> <span id="res-fli-val"></span> <span id="res-fli-class" class="font-extrabold"></span></li>
                        </ul>
                    </div>

                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <h4 class="font-bold text-gray-800 text-lg mb-2">Estilo de Vida y Fuerza üèÉ:</h4>
                        <ul class="list-disc list-inside text-base text-gray-700 space-y-1">
                            <li><span class="font-extrabold">√çndice Tab√°quico (IPA):</span> <span id="res-ipa-val"></span> <span id="res-ipa-class" class="font-extrabold"></span></li>
                            <li><span class="font-extrabold">Actividad F√≠sica:</span> <span id="res-activity-class" class="font-extrabold"></span></li>
                            <li><span class="font-extrabold">Fuerza de Agarre:</span> <span id="res-grip-class" class="font-extrabold"></span></li>
                        </ul>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="p-6 rounded-2xl border-4 border-red-200 bg-red-50/70 shadow-lg">
                        <h3 class="text-2xl font-extrabold mb-4 ipn-accent border-b pb-2">Factores Clave de Riesgo üî•</h3>
                        <ul id="risk-factors-list" class="space-y-3 text-base text-gray-700 list-disc ml-5">
                            </ul>
                    </div>

                    <div class="p-6 rounded-2xl border-4 border-emerald-500 bg-emerald-50/70 shadow-lg">
                        <h3 class="text-2xl font-extrabold mb-4 text-emerald-800 border-b border-emerald-500 pb-2">Plan de Acci√≥n Personalizado üéØ</h3>
                        <ul id="recommendations-list" class="space-y-3 text-gray-800 list-disc ml-5 text-base">
                            </ul>
                    </div>
                </div>
            </div>

            <div class="mt-10 no-print">
                <button id="print-button" class="w-full py-3 px-4 border border-blue-600 rounded-xl shadow-md text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-150 ease-in-out transform hover:scale-[1.005]">
                    üñ®Ô∏è Imprimir Reporte (PDF)
                </button>
            </div>

            <div class="mt-8 text-center border-t pt-4">
                <p class="text-xs text-gray-500 italic">**Nota Importante:** Esta herramienta es parte de un proyecto de tesis y no sustituye la evaluaci√≥n m√©dica profesional. Consulte a su m√©dico para un diagn√≥stico y tratamiento precisos.</p>
            </div>
        </div>

        <div class="border-t pt-4 mt-8 no-print"></div> 
        <div id="project-info" class="p-4 bg-gray-100 rounded-xl text-sm no-print shadow-inner">
            <h3 class="font-bold text-lg ipn-accent mb-2 border-b pb-1">Informaci√≥n del Proyecto y Colaboradores ü§ù</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="font-semibold text-gray-700">Presenta y Asesor√≠a:</p>
                    <p class="text-gray-600"><strong>Edsel Yahvi M√©ndez Hern√°ndez</strong></p>
                    <p class="text-gray-600">Asesora Externa: Dra. Nayelli N√°jera Garc√≠a</p>
                    <p class="text-gray-600">Asesor Interno (Docente): Dr. Bustos Garc√≠a Juan Roberto Israel</p>
                    <p class="font-semibold text-gray-700 mt-2">Instituci√≥n:</p>
                    <p class="text-gray-600">
                        <a href="https://www.esm.ipn.mx/" target="_blank" class="ipn-accent hover:text-red-800 font-semibold underline">
                             Escuela Superior de Medicina (ESM) - IPN
                        </a>
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-gray-700">Laboratorio Colaborador (LICAM):</p>
                    <p class="text-gray-600">Investigaci√≥n Integral Cardiometab√≥lica (IPN)</p>
                    
                    <p class="font-semibold text-gray-700 mt-2">Contacto y Ubicaci√≥n:</p>
                    <p class="text-gray-600">
                        <span class="font-medium">Ubicaci√≥n:</span> Plan de San Luis y D√≠az Mir√≥n s/n Col. Casco de Santo Tom√°s, Miguel Hidalgo, 11340, Ciudad de M√©xico, CDMX.
                    </p>
                    <p class="text-gray-600">
                        <span class="font-medium">Correo:</span> nnajerag@ipn.mx
                    </p>
                    <p class="text-gray-600">
                        <span class="font-medium">Tel√©fono:</span> 55 5729 6300 ext 62820
                    </p>
                    <p class="text-gray-600 mt-2">
                        <span class="font-medium">Sitio Web/Redes:</span> 
                        <a href="cemiztli.wixsite.com/cardiometabolismo" target="_blank" class="ipn-accent hover:text-red-800 font-semibold underline">
                             cemiztli.wixsite.com/cardiometabolismo
                        </a>,
                        <a href="https://www.facebook.com/licam.ipn" target="_blank" class="ipn-accent hover:text-red-800 font-semibold underline">
                             Facebook
                        </a>,
                        <a href="https://www.instagram.com/ipn_licam_lab" target="_blank" class="text-pink-600 hover:text-pink-800 font-semibold underline">
                             Instagram
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- BOT√ìN DE RESETEO MEJORADO -->
    <button type="button" id="reset-button" class="mt-4 py-2 px-4 border ipn-border rounded-xl shadow-md text-sm font-bold ipn-accent bg-white hover:bg-red-50 transition duration-150 ease-in-out fixed top-8 right-8 hidden no-print transform hover:scale-105">
        &larr; Calcular Nuevo
    </button>


    <script>
        // =======================================================
        // === CALCULADORA DE RIESGO INTEGRAL V2 - LOGIC.JS (SIN MODIFICACIONES) ====
        // =======================================================
        
        // --- CONFIGURACI√ìN DE INTEGRACI√ìN CON GOOGLE SHEETS (IMPORTANTE) ---
        // ¬°ACTUALIZADO CON TU √öLTIMA URL DE DESPLIEGUE!
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbweuEciVBAMuQgFMJe6HQrH4Q3v4aAKyhlZUr45lAIiZCseb095Hy8ljd2NDOvv42ODIw/exec";
        // --------------------------------------------------------------------
        
        // --- CONSTANTES GLOBALES Y PUNTOS DE CORTE (Basados en IMSS y Gu√≠as) ---
        const CONSTANTS = {
            // IMSS (1000167606.jpg)
            IMC: {
                NORMAL: 25,
                SOBREPESO: 30,
                OBESIDAD_I: 35
            },
            GLUCOSA: {
                NORMAL: 100,
                PREDIABETES: 126
            },
            HBA1C: { // A√±adido desde gu√≠as est√°ndar
                NORMAL: 5.7,
                PREDIABETES: 6.5
            },
            TRIGLICERIDOS: {
                NORMAL: 150,
                LIMITE: 200
            },
            COLESTEROL_TOTAL: {
                NORMAL: 200,
                LIMITE: 240
            },
            HDL_HOMBRES: {
                NORMAL: 40 // Riesgo si < 40
            },
            HDL_MUJERES: {
                NORMAL: 50 // Riesgo si < 50
            },
            LDL: { // A√±adido desde gu√≠as est√°ndar
                NORMAL: 100,
                LIMITE: 130,
                ALTO: 160
            },
            CINTURA_HOMBRES: {
                NORMAL: 90 // Riesgo si >= 90
            },
            CINTURA_MUJERES: {
                NORMAL: 80 // Riesgo si >= 80
            },
            // Gu√≠as Est√°ndar (No en las im√°genes)
            ICC_HOMBRES: { // √çndice Cintura-Cadera
                RIESGO_ALTO: 0.95 // > 0.95 es Riesgo Alto en hombres
            },
            ICC_MUJERES: {
                RIESGO_ALTO: 0.85 // > 0.85 es Riesgo Alto en mujeres
            },
            INDICE_TG_HDL: { // Triglic√©ridos / HDL
                ALTO_RIESGO: 3.5 // > 3.5 sugiere alta Resistencia a Insulina
            },
            INDICE_COL_HDL: { // Colesterol Total / HDL
                ALTO_RIESGO: 5.0 // > 5.0 es Alto Riesgo
            },
            IPA: { // √çndice Paquete-A√±o
                RIESGO_LEVE: 10
            },
            FLI_MASLD: { // Fatty Liver Index
                BAJO: 30,
                ALTO: 60
            }
        };

        // --- TABLA DE DINAMOMETR√çA (1000167605.jpg) ---
        const DYNAMOMETRY_P10 = {
            hombres: {
                "20-29": 33.9, 
                "30-39": 36.6,
                "40-49": 34.3,
                "50-59": 30.2,
                "60-69": 26.5,
                "70-99": 22.8, 
            },
            mujeres: {
                "20-29": 19.5,
                "30-39": 20.7,
                "40-49": 19.8,
                "50-59": 16.6,
                "60-69": 19.6, 
                "70-99": 13.0, 
            }
        };

        /**
         * Funci√≥n Principal: Se ejecuta cuando se presiona el bot√≥n "Calcular"
         */
        async function calculateRisk_v2() {
            const validationDiv = document.getElementById('validation-message');
            validationDiv.classList.add('hidden');
            document.getElementById('sheet-status').classList.add('hidden');
            
            console.log("Iniciando c√°lculo y env√≠o de datos v2...");
            
            // 1. Recolecci√≥n y C√°lculos de Edad
            const inputs = getUserInputs_v2();
            if (!inputs) {
                validationDiv.textContent = "‚ö†Ô∏è Por favor, complete todos los campos obligatorios (Secci√≥n 1-4) con valores num√©ricos v√°lidos (ej: edad, peso, estatura, glucosa, PAS/PAD).";
                validationDiv.classList.remove('hidden');
                return;
            }

            // 2. C√°lculos de M√©tricas Autom√°ticas (IMC, ICC, √çndices, etc.)
            const metrics = calculateMetrics(inputs);

            // 3. Chequeo de Comorbilidades (L√≥gica de Diagn√≥stico vs Medicamento)
            const healthStatus = checkComorbidities(inputs);

            // 4. C√°lculo del Score de Riesgo Heur√≠stico (El "Cerebro")
            const riskProfile = calculateHeuristicScore_v2(inputs, metrics, healthStatus);
            
            // 5. Env√≠o de Datos a Google Sheets (As√≠ncrono)
            await sendDataToSheets(inputs, metrics, riskProfile);
            
            // 6. Generaci√≥n de Resultados en la UI
            generateResults_v2(inputs, metrics, riskProfile);
            
            // 7. Guardar resultados en variable global para 'copiar'
            window.lastResultData_v2 = { inputs, metrics, riskProfile };

            // 8. Ocultar formulario y mostrar resultados
            document.getElementById('input-form').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('reset-button').classList.remove('hidden');
            window.scrollTo(0, 0);

            console.log("C√°lculo finalizado. Perfil de Riesgo:", riskProfile);
        }

        /**
         * PASO 5.1: Env√≠a los datos de entrada y resultados calculados a Google Sheets.
         */
        async function sendDataToSheets(inputs, metrics, riskProfile) {
            const statusDiv = document.getElementById('sheet-status');
            statusDiv.textContent = "Enviando datos a la base de datos (Google Sheets)...";
            statusDiv.className = "text-center p-3 mt-4 rounded-lg text-sm bg-blue-100 text-blue-800";
            statusDiv.classList.remove('hidden');
            
            // Consolidar todos los datos relevantes en un solo objeto para el POST
            const dataToSend = {
                timestamp: new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' }),
                fullName: inputs.full_name || 'Sin nombre',
                email: inputs.email || '',
                gender: inputs.gender === 'male' ? 'Masculino' : 'Femenino',
                age: inputs.age,
                
                // Signos y Antropometr√≠a
                paSistolica: inputs.pa_used.s,
                paDiastolica: inputs.pa_used.d,
                paSource: inputs.pa_used.source,
                hr: inputs.hr,
                rr: inputs.rr,
                weight: inputs.weight,
                height_cm: inputs.height_cm,
                waist: inputs.waist,
                hip: inputs.hip,
                
                // M√©tricas calculadas
                bmi: metrics.bmi,
                bmiClass: metrics.bmi_class,
                icc: metrics.icc,
                iccClass: metrics.icc_class,
                fliScore: metrics.fli_score,
                fliClass: metrics.fli_class,
                gripFactorText: riskProfile.grip_factor_text,

                // Bioqu√≠micos
                glucose: inputs.glucose,
                hba1c: inputs.hba1c,
                totalChol: inputs.total_chol,
                hdl: inputs.hdl,
                ldl: inputs.ldl,
                triglycerides: inputs.triglycerides,
                tgHdlIndex: metrics.tg_hdl,
                cholHdlIndex: metrics.chol_hdl,

                // Estilo de Vida
                activity: `${inputs.activity_days} d√≠as/${inputs.activity_duration} min (${inputs.activity_intensity})`,
                smokerStatus: inputs.smoker_status,
                ipaScore: metrics.ipa,
                alcoholFreq: inputs.alcohol_freq,

                // Comorbilidades
                dmStatus: inputs.dm_status,
                medDm: inputs.med_dm,
                htaStatus: inputs.hta_status,
                medHta: inputs.med_hta,
                dlpStatus: inputs.dlp_status,
                medDlp: inputs.med_dlp,
                historyMI: inputs.history_mi,
                familyHistory: inputs.family_history,
                
                // Resultados de Riesgo
                riskScore: riskProfile.score,
                riskLevel: riskProfile.level,
                riskFactorsList: riskProfile.factors.map(f => f.text).join(' | '),
            };
            
            try {
                // Usamos fetch con 'no-cors' para Apps Script POST
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend)
                });
                
                // Asumimos √©xito debido a 'no-cors'.
                statusDiv.textContent = "‚úÖ Datos guardados en Sheets con √©xito.";
                statusDiv.className = "text-center p-3 mt-4 rounded-lg text-sm bg-green-100 text-green-800";
                
            } catch (error) {
                console.error("Error al enviar datos a Google Sheets. La aplicaci√≥n local sigue funcionando.", error);
                statusDiv.textContent = "‚ùå Error al guardar datos en Sheets. Revise la consola. El c√°lculo local se complet√≥.";
                statusDiv.className = "text-center p-3 mt-4 rounded-lg text-sm bg-red-100 text-red-800";
            }
        }


        /**
         * PASO 1: Recolecta todos los datos del formulario HTML.
         */
        function getUserInputs_v2() {
            
            const getVal = (id) => document.getElementById(id)?.value || null;
            const getNum = (id) => parseFloat(document.getElementById(id)?.value) || null;
            const getRad = (name) => document.querySelector(`input[name="${name}"]:checked`)?.value || "no";

            // --- Helper: Calcular Edad ---
            const getAge = (birthDateString) => {
                if (!birthDateString) return null;
                const today = new Date();
                const birthDate = new Date(birthDateString);
                let age = today.getFullYear() - birthDate.getFullYear();
                const m = today.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            };

            const inputs = {
                // Secci√≥n 1
                full_name: getVal('full_name'),
                birth_date: getVal('birth_date'),
                age: getAge(getVal('birth_date')),
                gender: getVal('gender'),
                email: getVal('email'),
                // Secci√≥n 2
                hr: getNum('hr'),
                rr: getNum('rr'),
                grip_right: getNum('grip_right'),
                grip_left: getNum('grip_left'),
                // Secci√≥n 2.1 - Promedio de PA
                pa_used: getAverageBP(getNum('pas'), getNum('pad')),
                // Secci√≥n 3
                height_cm: getNum('height'),
                weight: getNum('weight'),
                waist: getNum('waist'),
                hip: getNum('hip'),
                // Secci√≥n 4
                glucose: getNum('glucose'),
                hba1c: getNum('hba1c'),
                total_chol: getNum('total_chol'),
                hdl: getNum('hdl'),
                ldl: getNum('ldl'),
                triglycerides: getNum('triglycerides'),
                // Secci√≥n 5 (BIA) - No se usan para el c√°lculo principal, solo para logging si se completan
                // Secci√≥n 6.1 (Actividad)
                activity_days: getNum('activity_days'),
                activity_duration: getNum('activity_duration'),
                activity_intensity: getVal('activity_intensity'),
                // Secci√≥n 6.2 (Tabaquismo)
                smoker_status: getVal('smoker_status'),
                smoker_passive: getVal('smoker_passive'),
                smoker_years: getNum('smoker_years'),
                smoker_daily_avg: getNum('smoker_daily_avg'),
                // Secci√≥n 6.3 (Alcohol)
                alcohol_freq: getVal('alcohol_freq'),
                alcohol_dose: getNum('alcohol_dose'),
                // Secci√≥n 7 (Comorbilidades)
                dm_status: getRad('dm_status'),
                med_dm: getVal('med_dm'),
                hta_status: getRad('hta_status'),
                med_hta: getVal('med_hta'),
                dlp_status: getRad('dlp_status'),
                med_dlp: getVal('med_dlp'),
                // Secci√≥n 8 (Historial)
                history_mi: getVal('history_mi'),
                history_angina: getVal('history_angina'),
                family_history: getVal('family_history')
            };

            // Validaci√≥n b√°sica (Campos obligatorios - Secciones 1 a 4)
            if (!inputs.age || inputs.age < 0 || !inputs.height_cm || !inputs.weight || !inputs.waist || !inputs.hip || !inputs.glucose || !inputs.total_chol || !inputs.hdl || !inputs.triglycerides || !inputs.pa_used) {
                return null; // Faltan datos clave
            }
            
            return inputs;
        }

        /**
         * Helper para PASO 1: Calcula el promedio de PA si existe.
         */
        function getAverageBP(pas, pad) {
            const bp_readings = [];
            
            // Lectura principal (obligatoria)
            if (pas && pad) {
                bp_readings.push({ s: pas, d: pad });
            } else {
                return null; // Si no hay lectura principal, no se puede calcular
            }

            // Lecturas opcionales
            const s2 = parseFloat(document.getElementById('pa_d2_s').value);
            const d2 = parseFloat(document.getElementById('pa_d2_d').value);
            if (!isNaN(s2) && !isNaN(d2) && s2 > 0 && d2 > 0) bp_readings.push({ s: s2, d: d2 });

            const s3 = parseFloat(document.getElementById('pa_d3_s').value);
            const d3 = parseFloat(document.getElementById('pa_d3_d').value);
            if (!isNaN(s3) && !isNaN(d3) && s3 > 0 && d3 > 0) bp_readings.push({ s: s3, d: d3 });

            const total_s = bp_readings.reduce((sum, reading) => sum + reading.s, 0);
            const total_d = bp_readings.reduce((sum, reading) => sum + reading.d, 0);
            
            return {
                s: Math.round(total_s / bp_readings.length),
                d: Math.round(total_d / bp_readings.length),
                source: bp_readings.length > 1 ? `Promedio de ${bp_readings.length} tomas` : "Toma √∫nica"
            };
        }


        /**
         * PASO 2: Calcula m√©tricas autom√°ticas (IMC, ICC, √çndices, FLI, IPA).
         */
        function calculateMetrics(inputs) {
            const metrics = {};
            const { weight, height_cm, waist, hip, triglycerides, hdl, total_chol, smoker_status, smoker_daily_avg, smoker_years } = inputs;

            // 1. IMC (√çndice de Masa Corporal)
            const height_m = height_cm / 100;
            metrics.bmi = parseFloat((weight / (height_m * height_m)).toFixed(1));
            metrics.bmi_class = getBmiClass(metrics.bmi);

            // 2. ICC (√çndice Cintura-Cadera)
            metrics.icc = parseFloat((waist / hip).toFixed(2));
            metrics.icc_class = getIccClass(metrics.icc, inputs.gender);

            // 3. √çndice TG/HDL
            metrics.tg_hdl = parseFloat((triglycerides / hdl).toFixed(2));
            metrics.tg_hdl_class = metrics.tg_hdl >= CONSTANTS.INDICE_TG_HDL.ALTO_RIESGO ? "Alto Riesgo" : "Normal";

            // 4. √çndice Col Total/HDL
            metrics.chol_hdl = parseFloat((total_chol / hdl).toFixed(2));
            metrics.chol_hdl_class = metrics.chol_hdl >= CONSTANTS.INDICE_COL_HDL.ALTO_RIESGO ? "Alto Riesgo" : "Normal";

            // 5. IPA (√çndice Paquete-A√±o)
            if (smoker_status === 'active' && smoker_daily_avg > 0 && smoker_years > 0) {
                metrics.ipa = parseFloat(((smoker_daily_avg / 20) * smoker_years).toFixed(1));
                metrics.ipa_class = metrics.ipa >= CONSTANTS.IPA.RIESGO_LEVE ? "Riesgo Elevado" : "Riesgo Bajo";
            } else {
                metrics.ipa = 0;
                metrics.ipa_class = "No aplica";
            }

            // 6. FLI (Fatty Liver Index)
            const ln_tg = Math.log(triglycerides);
            const ln_waist = Math.log(waist);
            const X = (0.953 * ln_tg) + (0.139 * metrics.bmi) + (0.718 * ln_waist) - 13.9;
            metrics.fli_score = parseFloat(((Math.exp(X) / (1 + Math.exp(X))) * 100).toFixed(1));
            metrics.fli_class = metrics.fli_score >= CONSTANTS.FLI_MASLD.ALTO ? "Alto Riesgo" : (metrics.fli_score >= CONSTANTS.FLI_MASLD.BAJO ? "Riesgo Moderado" : "Bajo Riesgo");
            
            return metrics;
        }

        // Helpers para Paso 2
        function getBmiClass(bmi) {
            if (bmi < 18.5) return "Bajo Peso";
            if (bmi < CONSTANTS.IMC.NORMAL) return "Normal";
            if (bmi < CONSTANTS.IMC.SOBREPESO) return "Sobrepeso";
            if (bmi < CONSTANTS.IMC.OBESIDAD_I) return "Obesidad Grado I";
            return "Obesidad Grado II+";
        }
        function getIccClass(icc, gender) {
            const cutoff = gender === 'male' ? CONSTANTS.ICC_HOMBRES.RIESGO_ALTO : CONSTANTS.ICC_MUJERES.RIESGO_ALTO;
            return icc >= cutoff ? "Riesgo Cardiovascular Alto" : "Riesgo Normal";
        }


        /**
         * PASO 3: Verifica comorbilidades (L√≥gica de Diagn√≥stico vs Medicamento).
         */
        function checkComorbidities(inputs) {
            const status = {
                dm: "no",
                hta: "no",
                dlp: "no"
            };

            // Diabetes
            if (inputs.dm_status === 'yes') {
                status.dm = "diagnosticada";
            } else if (inputs.med_dm === 'yes_freq') {
                status.dm = "tratada_no_dx"; // L√≥gica solicitada
            }

            // Hipertensi√≥n
            if (inputs.hta_status === 'yes') {
                status.hta = "diagnosticada";
            } else if (inputs.med_hta === 'yes_freq') {
                status.hta = "tratada_no_dx"; // L√≥gica solicitada
            }
            
            // Dislipidemia
            if (inputs.dlp_status === 'yes') {
                status.dlp = "diagnosticada";
            } else if (inputs.med_dlp === 'yes_freq') {
                status.dlp = "tratada_no_dx"; // L√≥gica solicitada
            }

            return status;
        }

        /**
         * PASO 4: Calcula el Score de Riesgo Heur√≠stico (El "Cerebro").
         */
        function calculateHeuristicScore_v2(inputs, metrics, healthStatus) {
            let score = 0;
            const riskFactors = []; // Lista de texto de factores de riesgo
            let gripFactor = { text: "Fuerza de Agarre No Medida", class: "risk-moderate" }; // Default

            // A. Edad y Sexo (Base Risk)
            if (inputs.age >= 45 && inputs.gender === 'male') {
                score += 10;
            } else if (inputs.age >= 55 && inputs.gender === 'female') {
                score += 10;
            }

            // B. Historial Cardiovascular (M√°xima Ponderaci√≥n)
            if (inputs.history_mi === 'yes') {
                score += 50; // Evento previo es el predictor m√°s fuerte
                riskFactors.push({ text: "Infarto Previo Diagnosticado", class: "risk-very-high" });
            }
            if (inputs.history_angina === 'yes') {
                score += 30; // S√≠ntomas de angina
                riskFactors.push({ text: "S√≠ntomas de Angina de Pecho", class: "risk-high" });
            }

            // C. Comorbilidades (Usando la l√≥gica del Paso 3)
            if (healthStatus.dm === 'diagnosticada') {
                score += 30;
                riskFactors.push({ text: "Diabetes Mellitus Diagnosticada", class: "risk-high" });
            } else if (healthStatus.dm === 'tratada_no_dx' || (inputs.hba1c && inputs.hba1c >= CONSTANTS.HBA1C.PREDIABETES) || inputs.glucose >= CONSTANTS.GLUCOSA.PREDIABETES) {
                score += 20;
                riskFactors.push({ text: "Estado de Prediabetes o DM no controlada", class: "risk-high" });
            }

            if (healthStatus.hta === 'diagnosticada') {
                score += 25;
                riskFactors.push({ text: "Hipertensi√≥n Diagnosticada", class: "risk-high" });
            } else if (healthStatus.hta === 'tratada_no_dx' || inputs.pa_used.s >= 140 || inputs.pa_used.d >= 90) {
                score += 20;
                riskFactors.push({ text: `Presi√≥n Arterial Elevada (${inputs.pa_used.s}/${inputs.pa_used.d} mmHg)`, class: "risk-high" });
            } else if (inputs.pa_used.s >= 130 || inputs.pa_used.d >= 85) {
                score += 10;
                riskFactors.push({ text: `Presi√≥n Arterial L√≠mite (${inputs.pa_used.s}/${inputs.pa_used.d} mmHg)`, class: "risk-moderate" });
            }

            // D. Par√°metros Bioqu√≠micos (Dislipidemia)
            if (inputs.ldl) { // Solo si se provey√≥ LDL
                 if (inputs.ldl >= CONSTANTS.LDL.ALTO) {
                     score += 20;
                     riskFactors.push({ text: `Colesterol LDL Muy Alto (>${CONSTANTS.LDL.ALTO})`, class: "risk-high" });
                } else if (inputs.ldl >= CONSTANTS.LDL.LIMITE) {
                     score += 10;
                     riskFactors.push({ text: `Colesterol LDL L√≠mite (>${CONSTANTS.LDL.LIMITE})`, class: "risk-moderate" });
                }
            }

            if (metrics.tg_hdl >= CONSTANTS.INDICE_TG_HDL.ALTO_RIESGO) {
                score += 15;
                riskFactors.push({ text: `√çndice TG/HDL Elevado (>${CONSTANTS.INDICE_TG_HDL.ALTO_RIESGO})`, class: "risk-high" });
            } else if (inputs.triglycerides >= CONSTANTS.TRIGLICERIDOS.LIMITE) {
                score += 5;
                riskFactors.push({ text: `Triglic√©ridos L√≠mite (>${CONSTANTS.TRIGLICERIDOS.LIMITE})`, class: "risk-moderate" });
            }

            if (metrics.chol_hdl >= CONSTANTS.INDICE_COL_HDL.ALTO_RIESGO) {
                score += 10;
                riskFactors.push({ text: `√çndice Col/HDL Elevado (>${CONSTANTS.INDICE_COL_HDL.ALTO_RIESGO})`, class: "risk-moderate" });
            }

            // E. Antropometr√≠a
            // L√ìGICA < 18 A√ëOS: Solo se suma si es mayor de edad.
            if (inputs.age >= 18) {
                if (metrics.bmi >= CONSTANTS.IMC.OBESIDAD_I) {
                    score += 20;
                    riskFactors.push({ text: `Obesidad General (IMC >${CONSTANTS.IMC.OBESIDAD_I})`, class: "risk-high" });
                } else if (metrics.bmi >= CONSTANTS.IMC.SOBREPESO) {
                    score += 10;
                    riskFactors.push({ text: `Sobrepeso (IMC >${CONSTANTS.IMC.NORMAL})`, class: "risk-moderate" });
                }
            } else {
                 riskFactors.push({ text: `IMC (${metrics.bmi}) no usado para score (menor de 18)`, class: "risk-moderate" });
            }
            // ICC (Obesidad Abdominal)
            if (metrics.icc_class === "Riesgo Cardiovascular Alto") {
                score += 15;
                riskFactors.push({ text: `Obesidad Abdominal (ICC Alto: ${metrics.icc})`, class: "risk-high" });
            }

            // F. Dinamometr√≠a (Sarcopenia/Fragilidad)
            const [newScore, dynFactor] = checkDynamometry(inputs, score);
            if (dynFactor) {
                score = newScore;
                riskFactors.push(dynFactor);
                gripFactor = dynFactor; // Para mostrar en el resumen
            }

            // G. Estilo de Vida
            if (metrics.ipa >= CONSTANTS.IPA.RIESGO_LEVE) {
                score += 20;
                riskFactors.push({ text: `Tabaquismo Activo (IPA: ${metrics.ipa})`, class: "risk-high" });
            } else if (inputs.smoker_passive === 'yes') {
                score += 5;
                riskFactors.push({ text: "Fumador Pasivo", class: "risk-moderate" });
            }

            // Actividad F√≠sica (Meta 150 min/sem moderada)
            const totalActivity = (inputs.activity_days * inputs.activity_duration) || 0;
            if (totalActivity < 150 && inputs.activity_intensity !== 'vigorous') {
                score += 10;
                riskFactors.push({ text: "Sedentarismo (No cumple 150 min/sem)", class: "risk-moderate" });
            }

            // Alcohol
            if (inputs.alcohol_freq === 'daily' && inputs.alcohol_dose >= 2) {
                score += 10;
                riskFactors.push({ text: "Consumo de Alcohol de Riesgo", class: "risk-moderate" });
            }

            // H. Historial Familiar
            if (inputs.family_history === 'yes') {
                score += 10;
                riskFactors.push({ text: "Antecedentes Familiares Positivos", class: "risk-moderate" });
            }

            // I. Riesgo Hep√°tico (MASLD)
            if (metrics.fli_class === "Alto Riesgo") {
                score += 10; // El riesgo hep√°tico aumenta el riesgo CV
                riskFactors.push({ text: `Alto Riesgo de MASLD (H√≠gado Graso)`, class: "risk-high" });
            }

            // Clasificaci√≥n Final del Score
            let riskLevel = "";
            let riskClass = "";
            if (score >= 100 || inputs.history_mi === 'yes' || inputs.history_angina === 'yes') {
                riskLevel = "MUY ALTO RIESGO";
                riskClass = "risk-very-high";
            } else if (score >= 60) {
                riskLevel = "ALTO RIESGO";
                riskClass = "risk-high";
            } else if (score >= 30) {
                riskLevel = "RIESGO MODERADO";
                riskClass = "risk-moderate";
            } else {
                riskLevel = "RIESGO BAJO";
                riskClass = "risk-low";
            }

            return {
                score: Math.round(score),
                level: riskLevel,
                css_class: riskClass,
                factors: riskFactors,
                grip_factor_text: gripFactor.text // Texto resumen de dinamometr√≠a
            };
        }

        // Helper para Paso 4: Dinamometr√≠a
        function checkDynamometry(inputs, currentScore) {
            const { age, gender, grip_right, grip_left } = inputs;
            if ((!grip_right || grip_right === 0) && (!grip_left || grip_left === 0) || !age) return [currentScore, null];

            const maxGrip = Math.max(grip_right || 0, grip_left || 0);
            
            // 1. Obtener rango de edad de la tabla
            let ageRange;
            if (age <= 29) ageRange = "20-29";
            else if (age <= 39) ageRange = "30-39";
            else if (age <= 49) ageRange = "40-49";
            else if (age <= 59) ageRange = "50-59";
            else if (age <= 69) ageRange = "60-69";
            else ageRange = "70-99";

            // 2. Obtener el P10 (punto de corte)
            const p10_cutoff = DYNAMOMETRY_P10[gender === 'male' ? 'hombres' : 'mujeres'][ageRange];

            // 3. Evaluar
            if (maxGrip < p10_cutoff) {
                const factor = {
                    text: `Baja Fuerza Muscular (Dinamometr√≠a < ${p10_cutoff} Kg)`,
                    class: "risk-high"
                };
                // Aumenta el score porque la sarcopenia es un factor de riesgo CV grave
                return [currentScore + 15, factor];
            } else {
                const factor = {
                    text: `Fuerza Muscular Normal (Dinamometr√≠a > P10)`,
                    class: "risk-low"
                };
                // No suma score, solo es informativo
                return [currentScore, factor];
            }
        }


        /**
         * PASO 6: Muestra los resultados en el HTML.
         */
        function generateResults_v2(inputs, metrics, riskProfile) {
            // 1. Nivel de Riesgo Global
            const riskDiv = document.getElementById('global-risk-result');
            riskDiv.innerHTML = `${riskProfile.level} (Score: ${riskProfile.score})`;
            // Aplicamos las nuevas clases de estilo al div de riesgo
            riskDiv.className = `text-center p-6 rounded-xl font-extrabold text-3xl mb-4 transition duration-300 shadow-glow ${riskProfile.css_class}`;

            // 2. Llenar M√©tricas Calculadas
            document.getElementById('res-age').textContent = inputs.age;
            document.getElementById('res-bmi-val').textContent = metrics.bmi;
            document.getElementById('res-bmi-class').textContent = `(${metrics.bmi_class})`;
            document.getElementById('res-icc-val').textContent = metrics.icc;
            document.getElementById('res-icc-class').textContent = `(${metrics.icc_class})`;

            document.getElementById('res-tg-hdl-val').textContent = metrics.tg_hdl;
            document.getElementById('res-tg-hdl-class').textContent = `(${metrics.tg_hdl_class})`;
            document.getElementById('res-chol-hdl-val').textContent = metrics.chol_hdl;
            document.getElementById('res-chol-hdl-class').textContent = `(${metrics.chol_hdl_class})`;
            
            document.getElementById('res-fli-val').textContent = metrics.fli_score;
            document.getElementById('res-fli-class').textContent = `(${metrics.fli_class})`;

            document.getElementById('res-ipa-val').textContent = metrics.ipa;
            document.getElementById('res-ipa-class').textContent = `(${metrics.ipa_class})`;
            
            const totalActivity = (inputs.activity_days * inputs.activity_duration) || 0;
            document.getElementById('res-activity-class').textContent = totalActivity >= 150 ? "Activo (Cumple meta)" : "Sedentario/Insuficiente";
            
            document.getElementById('res-grip-class').textContent = riskProfile.grip_factor_text;


            // 3. Llenar Lista de Factores de Riesgo
            const factorsList = document.getElementById('risk-factors-list');
            factorsList.innerHTML = ""; // Limpiar lista
            if (riskProfile.factors.length === 0) {
                factorsList.innerHTML = '<li class="text-green-600">¬°Felicidades! No se detectaron factores de riesgo mayores.</li>';
            } else {
                riskProfile.factors.forEach(factor => {
                    let colorClass = "text-gray-700";
                    if (factor.class === 'risk-very-high' || factor.class === 'risk-high') colorClass = "text-red-700 font-bold"; /* Ajuste de color y negrita */
                    if (factor.class === 'risk-moderate') colorClass = "text-yellow-700 font-semibold";
                    if (factor.class === 'risk-low') colorClass = "text-green-600";
                    
                    factorsList.innerHTML += `<li class="${colorClass}">${factor.text}</li>`;
                });
            }

            // 4. Llenar Recomendaciones (Personalizadas)
            const recList = document.getElementById('recommendations-list');
            recList.innerHTML = ""; // Limpiar lista
            
            // Recomendaciones basadas en los peores factores
            if (riskProfile.level === "MUY ALTO RIESGO" || riskProfile.level === "ALTO RIESGO") {
                 recList.innerHTML += `<li class="font-bold text-red-700">üõë Atenci√≥n Prioritaria: Su perfil indica un riesgo cardiovascular elevado. Es fundamental consultar a un m√©dico especialista a la brevedad.</li>`;
            }
            if (riskProfile.factors.some(f => f.text.includes("Diabetes") || f.text.includes("Prediabetes"))) {
                 recList.innerHTML += `<li>ü©∫ Controlar la glucosa y HbA1c es su prioridad #1. Requiere manejo m√©dico y un plan de alimentaci√≥n estricto.</li>`;
            }
            if (riskProfile.factors.some(f => f.text.includes("Tabaquismo"))) {
                 recList.innerHTML += `<li class="font-bold">üö≠ El cese del tabaquismo es la intervenci√≥n aislada m√°s importante que puede hacer. Busque apoyo profesional para dejar de fumar.</li>`;
            }
            if (riskProfile.factors.some(f => f.text.includes("Obesidad Abdominal") || f.text.includes("Sobrepeso"))) {
                 recList.innerHTML += `<li>‚öñÔ∏è La p√©rdida de peso (5-10% inicial) mejorar√° dr√°sticamente su presi√≥n arterial, glucosa y l√≠pidos. Enfoque en reducir grasa visceral.</li>`;
            }
             if (riskProfile.factors.some(f => f.text.includes("Baja Fuerza Muscular"))) {
                 recList.innerHTML += `<li>üí™ Su fuerza es baja (riesgo de sarcopenia). Se recomienda iniciar un **programa de ejercicio de fuerza** (pesas, ligas, lagartijas) 2-3 veces por semana, supervisado.</li>`;
            }
            if (riskProfile.factors.some(f => f.text.includes("Sedentarismo"))) {
                 recList.innerHTML += `<li>üèÉ Su nivel de actividad es insuficiente. Intente cumplir la meta de 150 minutos de actividad moderada (caminar r√°pido) por semana.</li>`;
            }
            if (riskProfile.factors.some(f => f.text.includes("MASLD"))) {
                 recList.innerHTML += `<li>ü´Ñ Su riesgo de H√≠gado Graso es alto. La intervenci√≥n principal es la **p√©rdida de peso** y la **reducci√≥n dr√°stica de az√∫cares y harinas refinadas**.</li>`;
            }
            if (recList.innerHTML === "") {
                recList.innerHTML = '<li>üéâ ¬°Excelente perfil! Mantenga un estilo de vida saludable y realice chequeos preventivos anuales.</li>';
            }
        }


        /**
         * Funci√≥n para resetear el formulario (v2)
         */
        function resetForm() {
            document.getElementById('input-form').classList.remove('hidden');
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('reset-button').classList.add('hidden');
            document.getElementById('sheet-status').classList.add('hidden');
            // Limpia los campos del formulario
            document.getElementById('calc-form').reset();
            window.scrollTo(0, 0);
        }

        /**
         * Funci√≥n de copiado (v2) - Se mantiene en el script, pero no se usa
         */
        function copyResults_v2() {
            if (!window.lastResultData_v2) {
                // Reemplazando alert()
                document.getElementById('validation-message').textContent = "No hay resultados para copiar. Por favor, calcula primero.";
                document.getElementById('validation-message').classList.remove('hidden');
                return;
            }
            
            const { inputs, metrics, riskProfile } = window.lastResultData_v2;
            
            // Generar texto plano
            let text = `--- PERFIL DE RIESGO CARDIOMETAB√ìLICO INTEGRAL ---\n`;
            text += `Nombre: ${inputs.full_name || 'No provisto'}\n`;
            text += `Edad: ${inputs.age} a√±os\n`;
            text += `Fecha: ${new Date().toLocaleString('es-MX', { timeZone: 'America/Mexico_City' })}\n\n`;
            
            text += `== RIESGO GLOBAL ==\n`;
            text += `NIVEL: ${riskProfile.level}\n`;
            text += `SCORE: ${riskProfile.score} puntos\n\n`;
            
            text += `== M√âTRICAS CLAVE ==\n`;
            text += `IMC: ${metrics.bmi} (${metrics.bmi_class})\n`;
            text += `√çndice Cintura-Cadera (ICC): ${metrics.icc} (${metrics.icc_class})\n`;
            text += `√çndice TG/HDL: ${metrics.tg_hdl} (${metrics.tg_hdl_class})\n`;
            text += `√çndice Col Total/HDL: ${metrics.chol_hdl} (${metrics.chol_hdl_class})\n`;
            text += `Riesgo MASLD (FLI): ${metrics.fli_score} (${metrics.fli_class})\n`;
            text += `√çndice Tab√°quico (IPA): ${metrics.ipa} (${metrics.ipa_class})\n`;
            text += `Fuerza de Agarre: ${riskProfile.grip_factor_text}\n`;
            text += `Presi√≥n Arterial Usada: ${inputs.pa_used.s}/${inputs.pa_used.d} mmHg (${inputs.pa_used.source})\n\n`;
            
            text += `== FACTORES DE RIESGO DETECTADOS ==\n`;
            if (riskProfile.factors.length > 0) {
                riskProfile.factors.forEach(f => {
                    text += `- ${f.text}\n`;
                });
            } else {
                text += `- Ning√∫n factor de riesgo mayor detectado.\n`;
            }
            
            text += `\n== PLAN DE ACCI√ìN RECOMENDADO ==\n`;
            const recListItems = document.getElementById('recommendations-list').children;
            Array.from(recListItems).forEach(item => {
                text += `* ${item.textContent}\n`;
            });
            
            text += `\n**Nota Importante:** Esta herramienta no sustituye la evaluaci√≥n m√©dica profesional.`;
            
            // Copiar al portapapeles
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    // Reemplazando alert() con un mensaje de estado temporal
                    const statusDiv = document.getElementById('sheet-status');
                    statusDiv.textContent = "¬°Resultados copiados al portapapeles!";
                    statusDiv.className = "text-center p-3 mt-4 rounded-lg text-sm bg-blue-100 text-blue-800";
                    statusDiv.classList.remove('hidden');
                    setTimeout(() => statusDiv.classList.add('hidden'), 3000);

                }).catch(err => {
                    console.error('Error al copiar: ', err);
                    // Reemplazando alert() con un mensaje de estado
                    document.getElementById('validation-message').textContent = "Error al copiar. Revisa la consola.";
                    document.getElementById('validation-message').classList.remove('hidden');
                });
            } else {
                // Fallback para navegadores antiguos
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                // Reemplazando alert() con un mensaje de estado temporal
                const statusDiv = document.getElementById('sheet-status');
                statusDiv.textContent = "¬°Resultados copiados al portapapeles! (modo fallback)";
                statusDiv.className = "text-center p-3 mt-4 rounded-lg text-sm bg-blue-100 text-blue-800";
                statusDiv.classList.remove('hidden');
                setTimeout(() => statusDiv.classList.add('hidden'), 3000);
            }
        }


        // --- Inicializador ---
        // Asegura que el DOM est√© cargado antes de asignar los botones
        document.addEventListener('DOMContentLoaded', () => {
            
            // Asigna la funci√≥n v2 (ahora async) al bot√≥n de c√°lculo
            const calcButton = document.getElementById('calculate-button');
            if (calcButton) {
                calcButton.onclick = async (e) => { // Importante: Hacer la funci√≥n async
                    e.preventDefault(); // Previene que el formulario se env√≠e
                    await calculateRisk_v2();
                };
            }

            // Asigna la funci√≥n de reseteo
            const resetButton = document.getElementById('reset-button');
            if (resetButton) {
                resetButton.onclick = resetForm;
            }

            // (MODIFICADO) Se comenta la funci√≥n de copiado
            /*
            const copyButton = document.getElementById('copy-button');
            if (copyButton) {
                copyButton.onclick = copyResults_v2;
            }
            */

            // (NUEVO) Asigna la funci√≥n de impresi√≥n al nuevo bot√≥n
            const printButton = document.getElementById('print-button');
            if (printButton) {
                printButton.onclick = (e) => {
                    e.preventDefault(); // Prevenir cualquier acci√≥n default del bot√≥n
                    window.print();
                };
            }
        });

    </script>
    
</body>
</html>
